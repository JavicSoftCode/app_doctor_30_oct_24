{% extends 'components/dasboard.html' %}
{% block content %}
    {% load static %}

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 px-md-4 main-content">

        <!-- Top Navbar -->
        {% include 'includes/top.html' %}

        <!-- Mensajes de ERRORES -->
        {% include 'includes/errosForms.html' %}

        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" class="row">
                    {% csrf_token %}

                    <h1 class="text-center text-primary mb-4"
                        style="font-weight: bold;font-size: 25px">{{ title1 }}</h1>

                    <div class="col-md-6">

                        <div class="text-center containerft" id="ContenedorFoto"
                             style="position: relative; margin-bottom: 18px; height: 284px">
                            <span class="classSpanFoto" style="font-size: 25px; font-weight: bold;">Foto <i
                                    class="fa fa-camera"></i></span>
                            <div class="containerftt">
                                <canvas id="Canvas" class="classCanvas" name="namFoto"></canvas>
                                <div class="btn-container" id="idBtnContainer" style="margin-top: 10px;">
                                    <div class="form-group">
                                        <div style="display: none">
                                            {{ form.foto }}
                                        </div>
                                        <!-- Botón para Subir Foto -->
                                        <div class="btn-subir-camara"
                                             style="display: flex; align-items: center; justify-content: space-between; margin-top: -50px">
                                            <div class="btnsubur">
                                                <button type="button"
                                                        onclick="document.getElementById('{{ form.foto.id_for_label }}').click()"
                                                        class="btn btn-primary-black"
                                                        style="background-color: #0b5ed7; color: white;">
                                                    Subir Imagen <i class="fa fa-user fa-lg"></i>
                                                </button>
                                            </div>
                                            <div class="btnsubur">
                                                <button type="button" id="btnCamera" class="btn btn-primary-black"
                                                        style="background-color: #0b5ed7; color: white;">
                                                    Usar Cámara <i class="fa fa-camera fa-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Botón para Tomar Foto -->
                                        <button type="button" id="btnTakePhoto" class="btn btn-danger"
                                                style="display: none; margin-right: 10px; position: absolute; top: 50%; right: 0; transform: translateY(-50%);">
                                            Tomar Foto
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Botón de X para eliminar imagen -->
                            <button type="button" id="btnClearCanvas"
                                    style="display: none; position: absolute; top: 10px; margin-left: 88%; background-color: red; color: white; border: none; font-size: 18px; cursor: pointer; padding: 5px; border-radius: 5px;">
                                X
                            </button>
                        </div>

                        <div class="file-upload-container">
                            <!-- Card para Curriculum (PDF) -->
                            <label class="file-upload-card" for="{{ form.curriculum.id_for_label }}">
                                <i class="fa fa-file-pdf" style="font-size: 25px; color: white"></i>
                                PDF CV<span class="uploaded-status">
            {% if doctor.curriculum %} ✅{% endif %}
        </span>
                                <span class="tooltip">
            {% if doctor.curriculum %} {{ doctor.curriculum.name }} {% endif %}
        </span> <!-- Tooltip para mostrar el nombre del archivo -->
                            </label>
                            <input type="file" id="{{ form.curriculum.id_for_label }}" name="curriculum"
                                   class="file-input" accept=".pdf">

                            <!-- Card para Firma Digital -->
                            <label class="file-upload-card" for="{{ form.firmaDigital.id_for_label }}">
                                <i class="fa fa-file-signature" style="font-size: 25px; color: white"></i>
                                Firma <span class="uploaded-status">
            {% if doctor.firmaDigital %} ✅{% endif %}
        </span>
                                <span class="tooltip">
            {% if doctor.firmaDigital %} {{ doctor.firmaDigital.name }} {% endif %}
        </span> <!-- Tooltip para mostrar el nombre del archivo -->
                            </label>
                            <input type="file" id="{{ form.firmaDigital.id_for_label }}" name="firmaDigital"
                                   class="file-input" accept=".jpg, .jpeg, .png">

                            <!-- Card para Imagen de Receta -->
                            <label class="file-upload-card" for="{{ form.imagen_receta.id_for_label }}">
                                <i class="fa fa-file-medical" style="font-size: 25px; color: white"></i>
                                Receta <span class="uploaded-status">
            {% if doctor.imagen_receta %} ✅{% endif %}
        </span>
                                <span class="tooltip">
            {% if doctor.imagen_receta %} {{ doctor.imagen_receta.name }} {% endif %}
        </span> <!-- Tooltip para mostrar el nombre del archivo -->
                            </label>
                            <input type="file" id="{{ form.imagen_receta.id_for_label }}" name="imagen_receta"
                                   class="file-input" accept=".jpg, .jpeg, .png">
                        </div>

                        <div class="form-group">
                            <label for="{{ form.cedula.id_for_label }}"
                                   class="form-label fw-bold">{{ form.cedula.label }}</label>
                            {{ form.cedula }}
                            {{ form.cedula.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.nombres.id_for_label }}"
                                   class="form-label fw-bold">{{ form.nombres.label }}</label>
                            {{ form.nombres }}
                            {{ form.nombres.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.apellidos.id_for_label }}"
                                   class="form-label fw-bold">{{ form.apellidos.label }}</label>
                            {{ form.apellidos }}
                            {{ form.apellidos.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.fecha_nacimiento.id_for_label }}"
                                   class="form-label fw-bold">{{ form.fecha_nacimiento.label }}</label>
                            {{ form.fecha_nacimiento }}
                            {{ form.fecha_nacimiento.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.direccion.id_for_label }}"
                                   class="form-label fw-bold">{{ form.direccion.label }}</label>
                            {{ form.direccion }}
                            {{ form.direccion.errors }}
                        </div>

                    </div>

                    <div class="col-md-6">

                        <div class="form-group">
                            <label for="{{ form.codigoUnicoDoctor.id_for_label }}"
                                   class="form-label fw-bold">{{ form.codigoUnicoDoctor.label }}</label>
                            {{ form.codigoUnicoDoctor }}
                            {{ form.codigoUnicoDoctor.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.especialidad.id_for_label }}"
                                   class="form-label fw-bold">{{ form.especialidad.label }}</label>
                            {{ form.especialidad }}  <!-- Campo select para especialidades -->
                            {{ form.especialidad.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.telefonos.id_for_label }}"
                                   class="form-label fw-bold">{{ form.telefonos.label }}</label>
                            {{ form.telefonos }}
                            {{ form.telefonos.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.email.id_for_label }}"
                                   class="form-label fw-bold">{{ form.email.label }}</label>
                            {{ form.email }}
                            {{ form.email.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.latitud.id_for_label }}"
                                   class="form-label fw-bold">{{ form.latitud.label }}</label>
                            {{ form.latitud }}
                            {{ form.latitud.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.longitud.id_for_label }}"
                                   class="form-label fw-bold">{{ form.longitud.label }}</label>
                            {{ form.longitud }}
                            {{ form.longitud.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.horario_atencion.id_for_label }}"
                                   class="form-label fw-bold">{{ form.horario_atencion.label }}</label>
                            {{ form.horario_atencion }}
                            {{ form.horario_atencion.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.duracion_cita.id_for_label }}"
                                   class="form-label fw-bold">{{ form.duracion_cita.label }}</label>
                            {{ form.duracion_cita }}
                            {{ form.duracion_cita.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.activo.id_for_label }}"
                                   class="form-label fw-bold">{{ form.activo.label }}</label>
                            {{ form.activo }}
                            {{ form.activo.errors }}
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <button class="btn me-2 grabar" id="guardar-btn" type="submit">{{ grabar }}</button>
                            <a class="btn btn-secondary cancelar" href="{{ back_url }}">Cancelar</a>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const canvas = document.getElementById('Canvas');
            const ctx = canvas.getContext('2d');
            const btnCamera = document.getElementById('btnCamera');
            const btnTakePhoto = document.getElementById('btnTakePhoto');
            const btnClearCanvas = document.getElementById('btnClearCanvas');
            const defaultImageUrl = "{{ default_image_url }}";  // URL del avatar predeterminado
            const currentImageUrl = "{{ current_image_url }}";  // URL de la imagen actual (si existe)
            const inputFileElement = document.getElementById('{{ form.foto.id_for_label }}');  // El input de archivo oculto

            let isDefaultImage = !currentImageUrl || currentImageUrl === defaultImageUrl;
            let videoStream = null;
            let videoElement = null;

            // Función para cargar una imagen en el canvas
            function drawImageToCanvas(imageSrc) {
                const image = new Image();
                image.src = imageSrc;
                image.onload = function () {
                    canvas.width = 180;
                    canvas.height = 180;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const scale = Math.min(canvas.width / image.width, canvas.height / image.height);
                    const x = (canvas.width / 2) - (image.width / 2) * scale;
                    const y = (canvas.height / 2) - (image.height / 2) * scale;
                    ctx.drawImage(image, x, y, image.width * scale, image.height * scale);
                };
            }

            // Cargar imagen inicial: imagen del doctor o avatar predeterminado
            drawImageToCanvas(currentImageUrl || defaultImageUrl);
            btnClearCanvas.style.display = isDefaultImage ? 'none' : 'block';

            // Subir imagen desde el archivo
            inputFileElement.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function () {
                    drawImageToCanvas(reader.result);
                    btnClearCanvas.style.display = 'block';  // Mostrar la "X" al cargar una imagen
                    isDefaultImage = false;
                };
                reader.readAsDataURL(file);
            });

            // Activar cámara
            btnCamera.addEventListener('click', async () => {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    videoStream = await navigator.mediaDevices.getUserMedia({video: true});
                    videoElement = document.createElement('video');
                    videoElement.srcObject = videoStream;
                    videoElement.play();
                    videoElement.onloadedmetadata = function () {
                        canvas.width = 180;
                        canvas.height = 180;
                        updateCanvas();
                        btnTakePhoto.style.display = 'block';
                    };
                }
            });

            function updateCanvas() {
                if (videoElement && videoElement.srcObject) {
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    requestAnimationFrame(updateCanvas);
                }
            }

            // Tomar foto y mostrarla en el canvas
            btnTakePhoto.addEventListener('click', () => {
                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                btnTakePhoto.style.display = 'none';
                btnClearCanvas.style.display = 'block';  // Mostrar la "X" después de tomar una foto
                isDefaultImage = false;
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                    videoElement.srcObject = null;
                }

                // Convertir el contenido del canvas a un Blob y asignarlo al input de archivo
                canvas.toBlob((blob) => {
                    // Crear un archivo a partir del blob para que se pueda enviar en el formulario
                    const file = new File([blob], 'foto_tomada.png', {type: 'image/png'});
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    inputFileElement.files = dataTransfer.files;
                }, 'image/png');
            });

            // Limpiar el canvas y restaurar la imagen predeterminada
            btnClearCanvas.addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);  // Limpiar el canvas
                drawImageToCanvas(defaultImageUrl);  // Restaurar la imagen predeterminada
                btnClearCanvas.style.display = 'none';  // Ocultar la "X"
                isDefaultImage = true;

                // Restablecer el input de archivo para permitir volver a cargar la misma imagen
                inputFileElement.value = '';
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fileInputs = document.querySelectorAll('.file-input');

            fileInputs.forEach(input => {
                const label = input.previousElementSibling; // Obtener la label correspondiente
                const icon = label.querySelector('i');
                const status = label.querySelector('.uploaded-status');
                const tooltip = label.querySelector('.tooltip');

                input.addEventListener('change', function () {
                    if (this.files.length > 0) {
                        const fileName = this.files[0].name; // Obtener el nombre del archivo
                        // Cambiar el color del icono a verde
                        icon.classList.add('uploaded'); // Suponiendo que defines un estilo 'uploaded'
                        // Mostrar el nombre del archivo en el tooltip
                        tooltip.textContent = fileName;
                        // Agregar el símbolo de verificación
                        status.innerHTML = ' ✅';
                    }
                });

                // Mostrar el tooltip al pasar el mouse
                label.addEventListener('mouseenter', function () {
                    tooltip.style.display = 'block'; // Muestra el tooltip
                });

                label.addEventListener('mouseleave', function () {
                    tooltip.style.display = 'none'; // Oculta el tooltip
                });

                // Inicializa el tooltip y el estado si ya hay un archivo cargado
                if (input.files.length > 0) {
                    const fileName = input.files[0].name;
                    tooltip.textContent = fileName;
                    status.innerHTML = ' ✅';
                }
            });
        });
    </script>

{% endblock content %}
